// ===========================================
// Zoom YouTube Automation - Prisma Schema
// マルチテナント対応版
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./data.db"
}

// -------------------------------------------
// 組織（テナント）
// -------------------------------------------
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique  // URL用のスラッグ
  plan        String   @default("free") // free, pro, enterprise

  // 制限
  maxMembers      Int @default(5)
  maxRecordings   Int @default(100) // 月間処理数

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  members         OrganizationMember[]
  recordings      Recording[]
  clients         Client[]
  reportTemplates ReportTemplate[]
  settings        Settings?
  invitations     Invitation[]
}

// -------------------------------------------
// ユーザー
// -------------------------------------------
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String?  // Credentials認証用
  image         String?  // プロフィール画像URL

  // OAuth情報
  googleId      String?  @unique

  // メール認証
  emailVerified DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // リレーション
  memberships   OrganizationMember[]
  invitationsSent Invitation[] @relation("InvitationSender")
}

// -------------------------------------------
// 組織メンバーシップ（多対多の中間テーブル）
// -------------------------------------------
model OrganizationMember {
  id             String   @id @default(cuid())
  role           String   @default("member") // owner, admin, member, viewer

  // 外部キー
  userId         String
  organizationId String

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // リレーション
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

// -------------------------------------------
// 招待
// -------------------------------------------
model Invitation {
  id             String   @id @default(cuid())
  email          String
  role           String   @default("member")
  token          String   @unique
  expiresAt      DateTime

  // 招待者
  invitedById    String
  invitedBy      User     @relation("InvitationSender", fields: [invitedById], references: [id])

  // 組織
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())

  @@index([email])
  @@index([organizationId])
}

// -------------------------------------------
// 録画レコード
// -------------------------------------------
model Recording {
  id              String   @id @default(cuid())

  // 組織（テナント）
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Zoom情報
  zoomMeetingId   String
  zoomMeetingUuid String?
  title           String
  hostEmail       String?
  duration        Int?     // 分単位
  meetingDate     DateTime
  zoomUrl         String   // 元のZoom録画URL

  // クライアント情報（タイトルから抽出）
  clientName      String?

  // YouTube情報
  youtubeVideoId  String?
  youtubeUrl      String?

  // 処理結果
  transcript      String?  // 文字起こし全文
  summary         String?  // 要約テキスト

  // クライアント向け報告書
  clientReport           String?    // 生成された報告書
  clientReportTemplateId String?    // 使用したテンプレートID
  clientReportGeneratedAt DateTime? // 生成日時

  // 外部連携
  sheetRowNumber  Int?     // Google Sheets の行番号
  notionPageId    String?  // Notion ページID

  // 同期ステータス（各サービスへの書き込み成功/失敗）
  youtubeSuccess  Boolean?  // YouTube アップロード成功
  sheetsSuccess   Boolean?  // Google Sheets 書き込み成功
  notionSuccess   Boolean?  // Notion 書き込み成功
  sheetsError     String?   // Sheets エラーメッセージ
  notionError     String?   // Notion エラーメッセージ

  // ステータス管理
  status          String   @default("PENDING")  // PENDING, DOWNLOADING, UPLOADING, TRANSCRIBING, SUMMARIZING, SYNCING, COMPLETED, FAILED
  errorMessage    String?

  // 処理時刻
  downloadedAt    DateTime?
  uploadedAt      DateTime?
  transcribedAt   DateTime?
  summarizedAt    DateTime?
  syncedAt        DateTime?

  // メタ情報
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // インデックス
  @@unique([organizationId, zoomMeetingId])
  @@index([organizationId])
  @@index([clientName])
  @@index([status])
  @@index([meetingDate])
}

// -------------------------------------------
// レポートテンプレート
// -------------------------------------------
model ReportTemplate {
  id             String   @id @default(cuid())

  // 組織
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String   // テンプレート名
  description    String?  // 説明
  content        String   // テンプレート本文（変数を含む）
  isDefault      Boolean  @default(false)  // デフォルトテンプレート
  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

// -------------------------------------------
// クライアントマスタ
// -------------------------------------------
model Client {
  id             String   @id @default(cuid())

  // 組織
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String   // クライアント名
  description    String?
  color          String?  // ダッシュボード表示用カラー
  zoomUrl        String?  // このZoom URLのミーティングを自動割当
  contactUrl     String?  // 連絡ツールURL（LINE, ChatWork等）
  contactType    String?  // ツール種別: line, messenger, chatwork, slack, teams, email, other
  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
}

// -------------------------------------------
// 処理ログ
// -------------------------------------------
model ProcessLog {
  id          String   @id @default(cuid())
  recordingId String
  step        String   // download, upload, transcribe, summarize, sync
  status      String   // started, completed, failed
  message     String?
  duration    Int?     // 処理時間（ミリ秒）

  createdAt   DateTime @default(now())

  @@index([recordingId])
}

// -------------------------------------------
// アプリケーション設定（組織ごと）
// -------------------------------------------
model Settings {
  id                   String   @id @default(cuid())

  // 組織（1対1）
  organizationId       String   @unique
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // YouTube設定
  youtubeEnabled       Boolean @default(true)
  youtubePrivacy       String  @default("unlisted") // private, unlisted, public

  // 文字起こし設定
  transcriptionEnabled Boolean @default(true)
  transcriptionLanguage String @default("ja")

  // 要約設定
  summaryEnabled       Boolean @default(true)
  summaryStyle         String  @default("detailed") // brief, detailed

  // Google Sheets設定
  sheetsEnabled        Boolean @default(true)

  // Notion設定
  notionEnabled        Boolean @default(false)

  // Zoom API認証情報
  zoomAccountId        String?
  zoomClientId         String?
  zoomClientSecret     String?
  zoomWebhookSecretToken String?

  // OpenAI API認証情報
  openaiApiKey         String?

  // Google API認証情報
  googleClientId       String?
  googleClientSecret   String?
  googleRefreshToken   String?  // OAuth リフレッシュトークン
  googleSpreadsheetId  String?

  // Notion API認証情報
  notionApiKey         String?
  notionDatabaseId     String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
