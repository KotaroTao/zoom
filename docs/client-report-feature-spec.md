# クライアント向け議事録生成機能 仕様書

## 1. 概要

### 1.1 目的
ミーティング録画から、クライアントに送付可能な形式の議事録・報告文書を自動生成する機能を実装する。

### 1.2 背景
現在、録画の要約は生成されているが、クライアントへ送付するためには手動でフォーマットを整える必要がある。この作業を自動化し、ワンクリックでコピー可能な形式で出力する。

---

## 2. 機能要件

### 2.1 出力フォーマット

```
本日のミーティングありがとうございました。

下記、本日の議事録＆動画となります。
引き続き、よろしくお願いいたします。

{日付} {時刻}

## 概要
{ミーティングの概要・参加者・目的}

## 主な議論
- {議論ポイント1}
- {議論ポイント2}
- ...

## 決定事項
- {決定事項1}
- {決定事項2}
- ...

## アクションアイテム
- [ ] {タスク1}（{担当者}、{期限}）
- [ ] {タスク2}（{担当者}、{期限}）
- ...

## 次のステップ
- {次のステップの説明}

ミーティング動画
{YouTube URL}
```

### 2.2 生成に必要なデータ

| データ | ソース | 必須/任意 |
|--------|--------|-----------|
| 日付・時刻 | `recording.meetingDate` | 必須 |
| 概要 | AI生成（文字起こしから） | 必須 |
| 主な議論 | AI生成（文字起こしから） | 必須 |
| 決定事項 | AI生成（文字起こしから） | 任意 |
| アクションアイテム | AI生成（文字起こしから） | 任意 |
| 次のステップ | AI生成（文字起こしから） | 任意 |
| YouTube URL | `recording.youtubeUrl` | 任意 |
| クライアント名 | `recording.clientName` | 任意 |

### 2.3 AI生成プロンプト

文字起こしテキストから構造化された議事録を生成するため、専用のプロンプトを使用：

```
以下のミーティング文字起こしから、クライアント向け議事録を生成してください。

出力形式（JSON）:
{
  "summary": "概要（参加者・目的・結論を含む1-2文）",
  "discussions": ["議論ポイント1", "議論ポイント2", ...],
  "decisions": ["決定事項1", "決定事項2", ...],
  "actionItems": [
    {"task": "タスク内容", "assignee": "担当者", "deadline": "期限"}
  ],
  "nextSteps": "次のステップの説明"
}
```

---

## 3. UI/UX設計

### 3.1 ダッシュボード - 録画詳細画面

**新規ボタン追加:**
- 「クライアント向け文書を生成」ボタン
- 既存の「要約」タブの隣、または録画カード内

**生成後の表示:**
- モーダルまたはサイドパネルで表示
- 「クリップボードにコピー」ボタン
- 「再生成」ボタン（必要に応じて）

### 3.2 ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────┐
│ 録画詳細                                    [×]         │
├─────────────────────────────────────────────────────────┤
│ タイトル: AXiY for Dental 導入ミーティング              │
│ 日時: 2026/01/21 13:59                                  │
│ クライアント: ゆうデンタルオフィス                      │
│ 状態: ✅ 完了                                           │
├─────────────────────────────────────────────────────────┤
│ [文字起こし] [要約] [クライアント報告] [YouTube]        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 本日のミーティングありがとうございました。       │   │
│  │                                                   │   │
│  │ 下記、本日の議事録＆動画となります。             │   │
│  │ 引き続き、よろしくお願いいたします。             │   │
│  │                                                   │   │
│  │ 2026年1月21日 13:59                               │   │
│  │                                                   │   │
│  │ ## 概要                                           │   │
│  │ AXiY for Dentalの導入に関するミーティングで...   │   │
│  │ ...                                               │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [📋 クリップボードにコピー]  [🔄 再生成]              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 録画一覧でのアクセス

録画カードに「📋」アイコンを追加し、クイックコピー機能を提供：
- アイコンクリックで即座にクライアント報告をクリップボードにコピー
- 未生成の場合は生成後にコピー

---

## 4. データモデル

### 4.1 Recordingテーブル拡張

```prisma
model Recording {
  // 既存フィールド
  id              String   @id
  title           String
  transcript      String?  // 文字起こし
  summary         String?  // 既存の要約

  // 新規フィールド
  clientReport    String?  // クライアント向け議事録（Markdown形式）
  clientReportGeneratedAt DateTime?  // 生成日時
}
```

### 4.2 生成データの保存形式

クライアント報告は完成形のMarkdown文字列として保存。
再生成時は上書き更新。

---

## 5. API設計

### 5.1 クライアント報告生成

**エンドポイント:** `POST /api/recordings/{id}/client-report`

**リクエスト:**
```json
{
  "regenerate": false  // trueの場合、既存を上書き再生成
}
```

**レスポンス:**
```json
{
  "success": true,
  "clientReport": "本日のミーティング...",
  "generatedAt": "2026-01-21T14:00:00Z"
}
```

### 5.2 クライアント報告取得

**エンドポイント:** `GET /api/recordings/{id}/client-report`

**レスポンス:**
```json
{
  "clientReport": "本日のミーティング...",
  "generatedAt": "2026-01-21T14:00:00Z",
  "exists": true
}
```

---

## 6. 処理フロー

### 6.1 自動生成フロー（推奨）

```
録画完了
    ↓
文字起こし完了
    ↓
要約生成（既存）
    ↓
クライアント報告生成（新規）← ここで自動実行
    ↓
YouTubeアップロード完了
    ↓
完了通知
```

### 6.2 手動生成フロー

```
ダッシュボードで録画を選択
    ↓
「クライアント報告」タブをクリック
    ↓
未生成の場合: 「生成」ボタンをクリック
    ↓
AI生成処理（5-10秒）
    ↓
結果表示
    ↓
「コピー」ボタンでクリップボードにコピー
```

---

## 7. テンプレート管理機能

### 7.1 概要

組織ごとに複数のテンプレートを作成・管理し、報告書生成時に選択できるようにする。

**ユースケース例:**
- 「通常ミーティング用」テンプレート
- 「初回打ち合わせ用」テンプレート（より丁寧な挨拶）
- 「進捗報告用」テンプレート（簡潔な形式）
- 「英語版」テンプレート

### 7.2 データモデル

```prisma
model ReportTemplate {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name           String   // テンプレート名（例: "通常ミーティング用"）
  description    String?  // 説明
  content        String   // テンプレート本文（変数を含む）
  isDefault      Boolean  @default(false)  // デフォルトテンプレート
  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
}

model Recording {
  // 既存フィールド

  // 新規フィールド
  clientReport           String?   // 生成された報告書
  clientReportTemplateId String?   // 使用したテンプレートID
  clientReportGeneratedAt DateTime?
}
```

### 7.3 テンプレート変数

| 変数 | 説明 | 例 |
|------|------|-----|
| `{{date}}` | ミーティング日付 | 2026年1月21日 |
| `{{time}}` | ミーティング時刻 | 13:59 |
| `{{datetime}}` | 日付と時刻 | 2026年1月21日 13:59 |
| `{{clientName}}` | クライアント名 | ゆうデンタルオフィス |
| `{{title}}` | ミーティングタイトル | AXiY導入ミーティング |
| `{{summary}}` | 概要 | （AI生成） |
| `{{discussions}}` | 主な議論（箇条書き） | - ポイント1\n- ポイント2 |
| `{{decisions}}` | 決定事項（箇条書き） | - 決定1\n- 決定2 |
| `{{actionItems}}` | アクションアイテム | - [ ] タスク1（担当、期限） |
| `{{nextSteps}}` | 次のステップ | （AI生成） |
| `{{youtubeUrl}}` | YouTube URL | https://youtube.com/... |
| `{{duration}}` | ミーティング時間 | 45分 |

### 7.4 デフォルトテンプレート例

**テンプレート1: 標準（議事録付き）**
```
本日のミーティングありがとうございました。

下記、本日の議事録＆動画となります。
引き続き、よろしくお願いいたします。

{{datetime}}

## 概要
{{summary}}

## 主な議論
{{discussions}}

## 決定事項
{{decisions}}

## アクションアイテム
{{actionItems}}

## 次のステップ
{{nextSteps}}

ミーティング動画
{{youtubeUrl}}
```

**テンプレート2: 簡易版（動画共有のみ）**
```
お世話になっております。

本日のミーティング動画を共有いたします。
ご確認のほど、よろしくお願いいたします。

{{datetime}}
{{title}}

▼ミーティング動画
{{youtubeUrl}}

何かご不明点がございましたら、お気軽にお問い合わせください。
```

**テンプレート3: 詳細版（初回ミーティング用）**
```
{{clientName}} 様

本日はお忙しい中、お時間をいただきありがとうございました。

下記、本日のミーティング内容をまとめましたのでご確認ください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ ミーティング概要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
日時: {{datetime}}
時間: {{duration}}

{{summary}}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 議論内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{{discussions}}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 決定事項
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{{decisions}}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ アクションアイテム
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{{actionItems}}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 次回に向けて
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{{nextSteps}}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ ミーティング動画
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{{youtubeUrl}}

引き続き、よろしくお願いいたします。
```

### 7.5 テンプレート管理UI

**設定画面に「テンプレート管理」セクションを追加:**

```
┌─────────────────────────────────────────────────────────────┐
│ 設定 > テンプレート管理                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [+ 新規テンプレート作成]                                   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ⭐ 標準（議事録付き）                    [編集] [削除] │   │
│  │ デフォルト | 通常のミーティング向け                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📋 簡易版（動画共有のみ）                [編集] [削除] │   │
│  │ 動画URLのみを共有したい場合                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📝 詳細版（初回ミーティング用）          [編集] [削除] │   │
│  │ 丁寧な形式の議事録                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**テンプレート編集画面:**

```
┌─────────────────────────────────────────────────────────────┐
│ テンプレート編集                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ テンプレート名: [標準（議事録付き）        ]                │
│                                                             │
│ 説明: [通常のミーティング向けテンプレート  ]                │
│                                                             │
│ ☑ デフォルトとして設定                                     │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 本日のミーティングありがとうございました。          │   │
│ │                                                      │   │
│ │ 下記、本日の議事録＆動画となります。                │   │
│ │ 引き続き、よろしくお願いいたします。                │   │
│ │                                                      │   │
│ │ {{datetime}}                                         │   │
│ │                                                      │   │
│ │ ## 概要                                              │   │
│ │ {{summary}}                                          │   │
│ │ ...                                                  │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 使用可能な変数:                                             │
│ {{date}} {{time}} {{datetime}} {{clientName}} {{title}}     │
│ {{summary}} {{discussions}} {{decisions}} {{actionItems}}   │
│ {{nextSteps}} {{youtubeUrl}} {{duration}}                   │
│                                                             │
│              [キャンセル]  [プレビュー]  [保存]             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.6 報告書生成時のテンプレート選択

**録画詳細画面でテンプレートを選択:**

```
┌─────────────────────────────────────────────────────────────┐
│ クライアント報告を生成                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ テンプレートを選択:                                         │
│                                                             │
│  ○ ⭐ 標準（議事録付き）← デフォルト                       │
│  ○ 📋 簡易版（動画共有のみ）                               │
│  ○ 📝 詳細版（初回ミーティング用）                         │
│                                                             │
│              [キャンセル]  [生成]                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. API設計

### 8.1 テンプレート管理API

**テンプレート一覧取得:**
```
GET /api/templates
```

**レスポンス:**
```json
{
  "templates": [
    {
      "id": "tpl_xxx",
      "name": "標準（議事録付き）",
      "description": "通常のミーティング向け",
      "isDefault": true,
      "createdAt": "2026-01-01T00:00:00Z"
    },
    ...
  ]
}
```

**テンプレート作成:**
```
POST /api/templates
```

**リクエスト:**
```json
{
  "name": "新規テンプレート",
  "description": "説明文",
  "content": "テンプレート本文...",
  "isDefault": false
}
```

**テンプレート更新:**
```
PUT /api/templates/{id}
```

**テンプレート削除:**
```
DELETE /api/templates/{id}
```

### 8.2 クライアント報告生成API（更新）

**エンドポイント:** `POST /api/recordings/{id}/client-report`

**リクエスト:**
```json
{
  "templateId": "tpl_xxx",  // 省略時はデフォルトテンプレート使用
  "regenerate": false
}
```

**レスポンス:**
```json
{
  "success": true,
  "clientReport": "本日のミーティング...",
  "templateId": "tpl_xxx",
  "templateName": "標準（議事録付き）",
  "generatedAt": "2026-01-21T14:00:00Z"
}
```

---

## 9. 実装計画

### Phase 1: テンプレート管理基盤
- [ ] Prismaスキーマ更新（ReportTemplateモデル追加）
- [ ] デフォルトテンプレート3種の初期データ作成
- [ ] テンプレート管理API実装（CRUD）
- [ ] 設定画面にテンプレート管理UI追加

### Phase 2: 報告書生成機能
- [ ] RecordingモデルにclientReport関連フィールド追加
- [ ] クライアント報告生成API実装
- [ ] AI生成プロンプト作成・調整
- [ ] テンプレート変数の置換処理実装
- [ ] ダッシュボードUI実装（タブ追加、テンプレート選択、コピーボタン）

### Phase 3: 自動化・利便性向上
- [ ] 要約生成後に自動でクライアント報告も生成（デフォルトテンプレート使用）
- [ ] 録画一覧でのクイックコピー機能
- [ ] テンプレートプレビュー機能
- [ ] クライアント別デフォルトテンプレート設定（将来）

---

## 10. 考慮事項

### 10.1 エラーハンドリング

- 文字起こしが未完了の場合: 「文字起こしが完了してから生成できます」
- YouTube未アップロードの場合: URL部分を省略または「（動画準備中）」と表示
- AI生成失敗時: リトライボタンを表示
- テンプレートが削除された場合: デフォルトテンプレートにフォールバック

### 10.2 パフォーマンス

- 生成は非同期で実行（ユーザーは待機不要）
- 生成済みの場合はキャッシュから即座に返却
- 長い文字起こしは要約を使用して生成（トークン節約）
- テンプレート一覧はキャッシュして高速表示

### 10.3 セキュリティ

- クライアント報告は録画と同じアクセス権限で保護
- テンプレートは組織内でのみ共有
- 組織外からのアクセス不可

---

## 11. 成功指標

- クライアント報告のコピー回数
- 手動編集なしでそのまま使用された割合
- 生成から送信までの時間短縮
- テンプレート別使用率

---

## 12. 備考

この仕様書は初期バージョンです。実装中に発生した課題や追加要件に応じて更新します。
